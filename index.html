<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
          rel="stylesheet">
    <title>No Anti-Aliasing Calendar (2 Weeks - Real Dates)</title>
    <style>
        body {
          margin: 0;
          background-color: white;
//          font-family: monospace;
  font-family: "IBM Plex Sans Condensed", sans-serif;

          image-rendering: pixelated;
          text-rendering: optimizeSpeed;
          -webkit-font-smoothing: none;
          -moz-osx-font-smoothing: grayscale;
          text-shadow: none;
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 984px;
        }
        table {
          border-collapse: collapse;
          width: 1304px;
          height: auto;
        }
        th, td {
          border: 1px solid black;
          padding: 10px;
          text-align: left;
          font-size: 48px;
          line-height: 1.3;
          color: black;
          background-color: white;
          width: calc(100% / 7);
          box-sizing: border-box;

        }
        td {
          vertical-align: top;
        }
        th {
          font-weight: normal;
          text-align: center;
        }

         :root {
          --black-dither: repeating-conic-gradient(
            from 0deg,
            black 0deg 1deg,
            white 1deg 2deg
          );
          }

        article.ec-event {
          font-size: 28px;
          display: block;
          border: 1px solid black;
          box-shadow: none;
          background-image: var(--black-dither);
          background-size: 2px 2px;
        }

	body .ec-title {
	  font-size: 48px;
	}

    body .ec-events {
        margin: 0 1px 0 1px;
    }

	body .ec-header .ec-day{
	  font-size: 48px;
	  line-height: 100%;
	  padding: 1px;
	}

	body .ec-day-head {
	  font-size: 48px;
	}

.not-current-month {
  -webkit-text-stroke: 1px #000;
  -webkit-text-stroke-color: #000;
  color: #fff;
}

.ec-day-grid div.ec-event-body {
    flex-direction: column;
}


        .current-month {
  -webkit-text-stroke: 1px #000;
  -webkit-text-stroke-color: #000;
  color: #000;
}

.cell-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.cell-content span.date {
  margin-top: 0;
  margin-bottom: auto;
}

        #ec {
            width: 1304px;
        }


        div.ec {
          --ec-l-300: 00%;
          --ec-l-500: 00%;
          --ec-l-600: 00%;
          --ec-l-700: 00%;



        }

        .ec-today .ec-day-head time {
            text-align: center;
            border-radius: 50%;
            border: 3px solid red;
            padding-left: 1px;
            padding-right: 1px;
            width: 48px;
        }
    </style>
    <script src="ical.es5.cjs"></script>
    <link href="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.12.0/event-calendar.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.12.0/event-calendar.min.js"></script>
</head>
<body>

<div id="ec"></div>

<script>

    function setTimeFromAnotherDate(dayDate, timeDate) {
        const clonedDayDate = new Date(dayDate); // Creates a copy
        return new Date(clonedDayDate.setHours(timeDate.getHours(), timeDate.getMinutes(), timeDate.getSeconds(), timeDate.getMilliseconds()));
    }

    function asEvent(calendarName, event, overrideStart) {

        if(overrideStart) {
              return {
                    start: overrideStart.toJSDate(),
                    end:  setTimeFromAnotherDate(overrideStart.toJSDate(), event.endDate.toJSDate()),
                    title: event.summary,
                    id: event.uid + overrideStart,
                    backgroundColor: "#ffffff",
                    textColor: "#000000",
                    allDay: event.startDate.isDate,
                    className: "calendar-" + calendarName
                  }
        } else {
                return {
                    start: event.startDate.toJSDate(),
                    end:  event.endDate.toJSDate(),
                    title: event.summary,
                    id: event.uid,
                    backgroundColor: "#ffffff",
                    textColor: "#000000",
                    allDay: event.startDate.isDate,
                    className: "calendar-" + calendarName
                  }
        }
    }


    function selectEventsBetween(start, end, events, calendarName) {

      let rv = [];

      for(event of events) {
        if(event.isRecurring()) {
              let expand = new ICAL.RecurExpansion({
                component: event.component,
                dtstart: event.startDate
              });

              let next = expand.next();
              while (next && next.toJSDate() <= end) {
                if (next.toJSDate() >= start) {
                  rv.push(asEvent(calendarName, event, next));
                }
                next = expand.next();
              }
          } else {
              rv.push(asEvent(calendarName, event));
          }
      }
      return rv;
    }


    function fetchAndParseIcal(icalUrl) {
      return fetch(icalUrl)
        .then(response => response.text())
        .then(icalDataText => {
          let jcalData = ICAL.parse(icalDataText);
          const icalComp = new ICAL.Component(jcalData);
          const events = icalComp.getAllSubcomponents("vevent").map(vevent => new ICAL.Event(vevent));
            return events;
        })
        .catch(error => console.error('Error fetching or parsing iCal data:', error));
    }

    function getEventsForDateRange(dateStart, dateEnd) {
      const icalUrls = [
        ['family-event','http://192.168.11.190/calendar1.ics'],
        ['family-holiday','http://192.168.11.190/calendar2.ics'],
        ['school-holiday','http://192.168.11.190/calendar3.ics']]; // hardcoded URLs

      return Promise.all(icalUrls.flatMap(icalUrl =>
          fetchAndParseIcal(icalUrl[1]).then(events => selectEventsBetween(dateStart, dateEnd, events, icalUrl[0]))
      )).then(events => events.flat())
      .catch(error => console.error('Error fetching or parsing iCal data:', error));
    }

    let ec = new EventCalendar(document.getElementById('ec'), {
    view: 'dayGridMonth',
    eventSources: [{
        events: function(fetchInfo, successCallback, failureCallback) { return getEventsForDateRange(fetchInfo.start, fetchInfo.end); }
    }],
    duration: {weeks: 2},
    firstDay: 1,
    headerToolbar: {start: '', center: 'title', end: ''},
    width: "1304px"
});
</script>

<!--script>

 function dateToDay(date) {
    return date?.toISOString()?.split('T')?.[0];
}

 document.addEventListener('DOMContentLoaded', function() {
    const monthNameElement = document.getElementById('month-name');
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
    const currentDate = new Date(today); // Create a copy to manipulate

    // Calculate the start date of the first week (Sunday)
    const daysSinceSunday = dayOfWeek;
    currentDate.setDate(today.getDate() - daysSinceSunday);

    // Set the month name
    const month = currentDate.getMonth(); // Month is 0-indexed
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    monthNameElement.textContent = monthNames[month];

    // Populate the day content
    for (let i = 1; i <= 14; i++) {

      let date = new Date(currentDate); // Create a new date object
      date.setDate(date.getDate() + i - 1); // Calculate the date
      let day = dateToDay(date);

      getEventsForDate(day).then(events => {

          let dateElement = document.getElementById(`day-${i}-date`);
          let eventsElement = document.getElementById(`day-${i}-events`);

          dateElement.textContent = date.getDate();

          if (date.getMonth() !== today.getMonth()) {
            dateElement.classList.add('not-current-month');
          } else {
            dateElement.classList.add('current-month');
          }

          eventsElement.innerHTML = '';

          events.forEach(event => {
            let eventElement = document.createElement('span');
            eventElement.className = 'event';
            eventElement.textContent = event.summary;
            eventsElement.appendChild(eventElement);
          });
      });
    }
  });

let icalDataPromise = null;



function fetchAndParseIcal() {
  const icalUrl = 'http://192.168.11.190/calendar.ics'; // hardcoded URL
  return fetch(icalUrl)
    .then(response => response.text())
    .then(icalDataText => {
      let jcalData = ICAL.parse(icalDataText);
      const icalComp = new ICAL.Component(jcalData);
      const events = icalComp.getAllSubcomponents("vevent").map(vevent => new ICAL.Event(vevent));
        return events;
    })
    .catch(error => console.error('Error fetching or parsing iCal data:', error));
}

function occursOnDate(day, event) {

    if(dateToDay(event.startDate.toJSDate()) === day) {
        return true;
    }

    let expand = new ICAL.RecurExpansion({
      component: event.component,
      dtstart: event.startDate
    });

    let next = dateToDay(expand.next()?.toJSDate());

    while (next != null && next <= day) {
      if(next === day) {
        return true;
      }
      next = dateToDay(expand.next()?.toJSDate());
    }

    return false;
}

function getEventsForDate(date) {
  if (!icalDataPromise) {
    icalDataPromise = fetchAndParseIcal();
  }
  return icalDataPromise.then(events => {

    const currentEvents = events.filter(event => occursOnDate(date, event));

    return currentEvents;
  });
}
</script-->

</body>
</html>
